# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Project Overview

A personal website (koenrane.xyz) built on Quartz 4.0 - a static site generator that transforms Markdown into a fast, searchable website. This is a heavily customized fork with custom plugins, transformers, and styling.

## Commands

```bash
npx quartz build --serve  # Build and serve locally with hot reload
npm run check             # TypeScript + Prettier check
npm run format            # Auto-format with Prettier
npm test                  # Jest unit tests
npm run test:visual       # Playwright visual regression tests
```

## Before Committing

**Always run:**
```bash
npm run check && npm test
```

This runs TypeScript type checking, Prettier formatting validation, and all unit tests. Do not commit if either fails.

## Do Not Modify

These files/directories should not be changed:

| Path | Reason |
|------|--------|
| `quartz/` core files | Only modify `quartz/components/` and `quartz/styles/`. Other core files (`build.ts`, `cfg.ts`, `processors/`, `plugins/`, `util/`, etc.) are stable and should not be changed. |
| `package-lock.json` | Only update via `npm install`. Never edit manually. |
| `.github/workflows/` | CI/CD pipelines are working. Do not modify. |
| `patches/` | Generated by patch-package. Do not edit manually. |

## Architecture

### Build Pipeline

Markdown content flows through a three-stage plugin pipeline:

1. **Transformers** - Process markdown/HTML AST (parsing, syntax highlighting, link processing)
2. **Filters** - Determine what to publish (draft filtering)
3. **Emitters** - Generate output files (HTML pages, RSS, sitemap, search index)

### Key Directories

| Directory | Purpose |
|-----------|---------|
| `content/` | Markdown source files |
| `public/` | Build output |
| `quartz/components/` | Preact UI components |
| `quartz/plugins/` | Transformer/Filter/Emitter plugins |
| `quartz/styles/` | SCSS stylesheets |

### Configuration

- `quartz.config.ts` - Main config (plugins, analytics, locale)
- `quartz.layout.ts` - Page layout (which components go where)

## Common Workflows

### Adding New Content

1. Create markdown file in `content/` directory
2. Add frontmatter with at least `title`
3. Run `npm run docs` to preview locally
4. Content appears automatically after build

### Creating a New Component

1. Create `quartz/components/MyComponent.tsx`:
   ```typescript
   import { QuartzComponent, QuartzComponentConstructor, QuartzComponentProps } from "./types"

   const MyComponent: QuartzComponent = ({ fileData, cfg }: QuartzComponentProps) => {
     return <div className="my-component">...</div>
   }

   MyComponent.css = `.my-component { /* styles */ }`
   MyComponent.afterDOMLoaded = `// client-side JS`

   export default (() => MyComponent) satisfies QuartzComponentConstructor
   ```
2. Export from `quartz/components/index.ts`
3. Add to appropriate section in `quartz.layout.ts`
4. Run `npm run check` to verify types

### Modifying Styles

1. Edit SCSS files in `quartz/styles/`
2. For layout variables, edit `quartz/styles/variables.ts` then run `npm run generate:scss`
3. Component-specific styles go in the component's `css` property
4. Run `npm run docs` to preview changes with hot reload

### Debugging Build Issues

1. **Build fails silently**: Run with verbose flag or check terminal output
2. **Content not appearing**: Check frontmatter for `draft: true`
3. **Styles not applying**: Clear browser cache, check CSS specificity
4. **Type errors**: Run `npm run check` for detailed error messages
5. **Hot reload not working**: Restart dev server with `npm run docs`

### Adding a New Transformer Plugin

1. Create file in `quartz/plugins/transformers/`
2. Export from `quartz/plugins/transformers/index.ts`
3. Add to transformer array in `quartz.config.ts`
4. Add tests in `quartz/plugins/transformers/tests/`

## Key Files Reference

### Site Configuration
| File | What to change |
|------|----------------|
| `quartz.config.ts` | Site title, plugins, analytics, locale, navbar links |
| `quartz.layout.ts` | Component placement (header, sidebar, footer) |

### Layout & Components
| File | What to change |
|------|----------------|
| `quartz/components/` | UI components (create new or modify existing) |
| `quartz/components/index.ts` | Export new components here |
| `quartz/components/renderPage.tsx` | Page assembly logic (rarely needs changes) |

### Styling
| File | What to change |
|------|----------------|
| `quartz/styles/custom.scss` | Site-specific style overrides |
| `quartz/styles/base.scss` | Core layout and typography |
| `quartz/styles/colors.scss` | Color palette definitions |
| `quartz/styles/variables.ts` | Shared layout constants (page width, breakpoints) |

### Content Structure
| File | What to change |
|------|----------------|
| `content/` | All markdown content lives here |
| `quartz/plugins/vfile.ts` | Frontmatter field definitions |
| `quartz/plugins/filters/` | Content filtering logic |

### Build Process
| File | What to change |
|------|----------------|
| `quartz/build.ts` | Build orchestration (do not modify) |
| `quartz/processors/` | Parse/filter/emit pipeline (do not modify) |
| `quartz/cli/handlers.ts` | CLI and dev server (do not modify) |

## Code Standards

### TypeScript Rules
- **Always declare types explicitly** - no `any`, no implicit types
- **Strict null checks enabled** - handle null/undefined explicitly
- Use branded path types: `FilePath`, `FullSlug`, `SimpleSlug`, `RelativeURL`
- Preact JSX with `jsxImportSource: "preact"`

### Formatting (Prettier)
- 100 character line width
- 2 space indentation
- No semicolons
- Trailing commas everywhere
- Quotes only as needed in objects

### Code Change Rules
- **Make minimal, targeted changes** - do not refactor unrelated code
- **Keep diffs as small as possible** - easier to review
- **Never break existing functionality** - test before committing
- **Do not delete existing comments** - they exist for a reason
- **Preserve existing code structures** - don't reorganize without reason
- **Avoid magic numbers** - use named constants
- **No placeholders or TODOs** - deliver production-ready code

### Naming Conventions
- Use explicit, descriptive variable names
- Follow existing naming patterns in the codebase
- Constants in SCREAMING_SNAKE_CASE

## Content Rules

### Frontmatter Fields
Required:
- `title` - Page title

Optional:
- `description` - Meta description
- `tags` - Array of tags
- `aliases` - Alternative URLs
- `draft: true` - Excludes from build
- `date_published` - Publication date
- `date_updated` - Last update date
- `status` - "in-progress" | "finished" | "abandoned"
- `hide_metadata` - Hide sidebar metadata
- `hide_reading_time` - Hide reading time
- `toc` - Enable/disable table of contents

### Draft Content
Set `draft: true` in frontmatter to exclude content from the build. The `RemoveDrafts` filter handles this.

## Testing

### Unit Tests
- Location: alongside source files (e.g., `foo.test.ts` next to `foo.ts`)
- Transformer tests: `quartz/plugins/transformers/tests/`
- Run: `npm test`

### Visual Tests
- Location: `quartz/components/tests/`
- Cross-browser: Chrome, Firefox, Safari
- Cross-device: Desktop, iPad Pro, iPhone 12
- Run: `npm run test:visual`

### Test Requirements
- Add tests for new functionality
- Ensure existing tests pass before committing
- Consider edge cases in test coverage

## Common Gotchas

- **Transformer order matters**: HTML formatting must come after mermaid plugin
- **Path types are branded**: Use the correct type (`FilePath` vs `FullSlug` vs `SimpleSlug`)
- **Clone HAST before mutating**: Use `rfdc` to avoid modifying cached content
- **Critical CSS**: Generated automatically during build, can skip with `--skipCriticalCSS`
- **Strict TypeScript**: `noImplicitAny` and `strictNullChecks` are enabled
